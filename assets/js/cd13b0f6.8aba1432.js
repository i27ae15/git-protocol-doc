"use strict";(self.webpackChunkgit_protocol=self.webpackChunkgit_protocol||[]).push([[960],{3446:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>d,contentTitle:()=>c,default:()=>a,frontMatter:()=>o,metadata:()=>s,toc:()=>h});const s=JSON.parse('{"id":"git-protocol/ref-delta","title":"5. Parsing REF_DELTA","description":"It\'s time to talk about a new object, the REF_DELTA; this objects objective is designed to minimize storage requirements by referencing existing data instead of storing duplicate content.","source":"@site/docs/git-protocol/ref-delta.md","sourceDirName":"git-protocol","slug":"/git-protocol/ref-delta","permalink":"/git-protocol-doc/docs/git-protocol/ref-delta","draft":false,"unlisted":false,"editUrl":"https://github.com/i27ae15/git-protocol-doc/docs/git-protocol/ref-delta.md","tags":[],"version":"current","sidebarPosition":6,"frontMatter":{"sidebar_position":6},"sidebar":"tutorialSidebar","previous":{"title":"4. Object Header","permalink":"/git-protocol-doc/docs/git-protocol/object-header"},"next":{"title":"6. Reading Pack File","permalink":"/git-protocol-doc/docs/git-protocol/reading-pack-file"}}');var i=n(4848),r=n(8453);const o={sidebar_position:6},c="5. Parsing REF_DELTA",d={},h=[{value:"REF_DELTA Structure",id:"ref_delta-structure",level:2},{value:"Part 1: SHA1 Reference",id:"part-1-sha1-reference",level:3},{value:"Part 2: Source and Target Size",id:"part-2-source-and-target-size",level:3},{value:"Part 3: Instructions",id:"part-3-instructions",level:3},{value:"COPY",id:"copy",level:4},{value:"ADD",id:"add",level:4},{value:"Breakdown:",id:"breakdown",level:5},{value:"Key Points:",id:"key-points",level:4}];function l(e){const t={admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",h5:"h5",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(t.header,{children:(0,i.jsx)(t.h1,{id:"5-parsing-ref_delta",children:"5. Parsing REF_DELTA"})}),"\n",(0,i.jsxs)(t.p,{children:["It's time to talk about a new object, the ",(0,i.jsx)(t.code,{children:"REF_DELTA"}),"; this objects objective is designed to minimize storage requirements by referencing existing data instead of storing duplicate content."]}),"\n",(0,i.jsxs)(t.p,{children:["First, let's understand how the ",(0,i.jsx)(t.code,{children:"REF_DELTA"})," object is structured:"]}),"\n",(0,i.jsx)(t.h2,{id:"ref_delta-structure",children:"REF_DELTA Structure"}),"\n",(0,i.jsxs)(t.p,{children:["Taking out the object header, the ",(0,i.jsx)(t.code,{children:"REF_DELTA"})," body is separated in 3 parts:"]}),"\n",(0,i.jsxs)(t.ol,{children:["\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:"SHA1 Reference:"})," The SHA1 that is the reference to the object we want to work with (in raw bytes)."]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:"Source and Target Size:"})," Specifies the sizes of the referenced object (source) and the final object after applying the delta (target)."]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:"Instructions:"})," A series of ",(0,i.jsx)(t.code,{children:"COPY"})," and ",(0,i.jsx)(t.code,{children:"ADD"})," commands that reconstruct the object from the referenced data."]}),"\n"]}),"\n",(0,i.jsxs)(t.p,{children:["Here is an example of a ",(0,i.jsx)(t.code,{children:"REF_DELTA"})," object:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:"< bytes >\n49 a6 dd 7a 7f 92 b9 42 53 49 d3 78 49 a3 29 49 f9 92 93 a9\n< bytes >\n\n< z_lib compressed >\n\n30 03 - Encoded source size: 0x30.\n50 01 - Encoded target size: 0x50.\n\n...............................................................................\n\nc0 00 04     - COPY\n12 34 ab cd  - ADD\n\n< z_lib compressed >\n\n"})}),"\n",(0,i.jsx)(t.p,{children:"Les see one by one:"}),"\n",(0,i.jsx)(t.h3,{id:"part-1-sha1-reference",children:"Part 1: SHA1 Reference"}),"\n",(0,i.jsxs)(t.p,{children:["This is just the SHA1 that the ",(0,i.jsx)(t.code,{children:"REF_DELTA"})," is referencing, so, in other words, this is\nwhat tells us which object we want to take the data from."]}),"\n",(0,i.jsx)(t.admonition,{type:"note",children:(0,i.jsx)(t.p,{children:"This SHA1 could be referencing a Blob, Commit or Tree object."})}),"\n",(0,i.jsx)(t.h3,{id:"part-2-source-and-target-size",children:"Part 2: Source and Target Size"}),"\n",(0,i.jsxs)(t.p,{children:["The source size represents the size of the referenced object, while the target size is the size of the object after applying all the ",(0,i.jsx)(t.code,{children:"COPY"})," and ",(0,i.jsx)(t.code,{children:"ADD"})," instructions."]}),"\n",(0,i.jsxs)(t.p,{children:["Both sizes are encoded similarly to the size in an object header, the only difference\nis that the size is withing bits ",(0,i.jsx)(t.code,{children:"6-0"}),", not ",(0,i.jsx)(t.code,{children:"3-0"})," and still, the MSB indicates\ncontinuation, the steps are the same:"]}),"\n",(0,i.jsxs)(t.ol,{children:["\n",(0,i.jsxs)(t.li,{children:["Extracts bits ",(0,i.jsx)(t.code,{children:"6-0"}),"."]}),"\n",(0,i.jsx)(t.li,{children:"Combine them to the size."}),"\n",(0,i.jsx)(t.li,{children:"Check for the MSB to see if the next byte is part of the current size."}),"\n",(0,i.jsxs)(t.li,{children:["In case it is, shift the necessary bits by ",(0,i.jsx)(t.code,{children:"7N"})," where ",(0,i.jsx)(t.code,{children:"N"})," first value is ",(0,i.jsx)(t.code,{children:"0"}),"."]}),"\n"]}),"\n",(0,i.jsx)(t.h3,{id:"part-3-instructions",children:"Part 3: Instructions"}),"\n",(0,i.jsxs)(t.p,{children:["In a ",(0,i.jsx)(t.code,{children:"REF_DELTA"})," object we have two type of instructions:"]}),"\n",(0,i.jsxs)(t.ol,{children:["\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:"COPY:"})," Copies data from the referenced object based on a specified offset and size."]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:"ADD:"})," Inserts literal data into the object."]}),"\n"]}),"\n",(0,i.jsxs)(t.p,{children:["Where the first bit indicates the type of the command, ",(0,i.jsx)(t.code,{children:"1"})," for ",(0,i.jsx)(t.code,{children:"COPY"}),", ",(0,i.jsx)(t.code,{children:"0"})," for ",(0,i.jsx)(t.code,{children:"ADD"}),"."]}),"\n",(0,i.jsx)(t.admonition,{type:"note",children:(0,i.jsxs)(t.p,{children:["Have in mind that there could be many ",(0,i.jsx)(t.code,{children:"COPY"})," or many ",(0,i.jsx)(t.code,{children:"ADD"})," command together, for example"]})}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:"            This is valid:  | This is also valid | And also this is valid\n\n               `COPY`                `COPY`                 `ADD`\n               `ADD`                 `COPY`                 `ADD`\n               `COPY`                `COPY`                 `ADD`\n               `ADD`                 `ADD`                  `COPY`\n               .....                 .....                  .....\n"})}),"\n",(0,i.jsx)(t.h4,{id:"copy",children:"COPY"}),"\n",(0,i.jsxs)(t.p,{children:["This instructions tell us to go to the file referenced by the SHA1 and ",(0,i.jsx)(t.code,{children:"COPY X"})," values from it starting at ",(0,i.jsx)(t.code,{children:"OFFSET Y"}),", the\nencoding goes as follow"]}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:"Bits 6-4:"})," Specify the size to copy."]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:"Bits 3-0:"})," Specify where to start copying (offset)."]}),"\n"]}),"\n",(0,i.jsx)(t.p,{children:"The bits indicates the number of bytes that correspond to the offset (max of 4 bytes) and the bytes that are part of the size, and also the amount to be shifted by. This sounds complicated but is not. Let me explain:"}),"\n",(0,i.jsxs)(t.p,{children:["Let's say we have the byte ",(0,i.jsx)(t.code,{children:"\\xD6"})," which in binary equals ",(0,i.jsx)(t.code,{children:"1101 0110"}),", the first thing to do is to check the MSB to see if this\nis equal to ",(0,i.jsx)(t.code,{children:"1"})," or ",(0,i.jsx)(t.code,{children:"0"})," (or check if the byte is bigger than ",(0,i.jsx)(t.code,{children:"127"}),"), which in this case, we easily see that it equals to ",(0,i.jsx)(t.code,{children:"1"}),"\nindicating a ",(0,i.jsx)(t.code,{children:"COPY"})," command, so let's parse the bits ",(0,i.jsx)(t.code,{children:"6 - 4"})," that indicate the size."]}),"\n",(0,i.jsxs)(t.p,{children:["By checking at bits ",(0,i.jsx)(t.code,{children:"6 - 4"})," we get the following value ",(0,i.jsx)(t.code,{children:"101"}),", telling us that the following 2 bytes are part of the size, other\nexamples for the bits ",(0,i.jsx)(t.code,{children:"6 - 4"})," could be:"]}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.code,{children:"100"})," : The following byte is part of the size."]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.code,{children:"010"})," : The following byte is part of the size."]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.code,{children:"001"})," : The following byte is part of the size."]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.code,{children:"011"})," : The following 2 bytes are part of the size."]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.code,{children:"111"})," : The following 3 bytes are part of the size."]}),"\n"]}),"\n",(0,i.jsxs)(t.p,{children:['Now, I guess you are wondering "Well what is the difference between the first three examples? The three of them are saying that\nonly the next byte is part of the size. Or what is the difference between ',(0,i.jsx)(t.code,{children:"011"})," and ",(0,i.jsx)(t.code,{children:"101"}),' they both seem to indicate that the next\n2 bytes are part of the size".']}),"\n",(0,i.jsx)(t.p,{children:'The answer to this questions is "the position refers to the shifting of that byte":'}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.code,{children:"100"})," : The following byte is part of the size."]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.code,{children:"010"})," : The following byte is part of the size & should be shifted by ",(0,i.jsx)(t.code,{children:"8"}),"."]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.code,{children:"001"})," : The following byte is part of the size & should be shifted by ",(0,i.jsx)(t.code,{children:"16"}),"."]}),"\n"]}),"\n",(0,i.jsxs)(t.p,{children:["And the same goes for two or three 1s and for the offset as well. This allows GIT to be able to make copies from files as big as\n",(0,i.jsx)(t.code,{children:"4,294,967,295"})," (max value for ",(0,i.jsx)(t.code,{children:"32uint_t"}),") characters long or about ",(0,i.jsx)(t.code,{children:"~4 GB"}),", in chunks of max ",(0,i.jsx)(t.code,{children:"16,777,215"})," characters which is\n",(0,i.jsx)(t.code,{children:"~16 MB"}),"."]}),"\n",(0,i.jsxs)(t.p,{children:["Following our example where we have ",(0,i.jsx)(t.code,{children:"101"}),", two bytes for the size, and ",(0,i.jsx)(t.code,{children:"0110"}),", two bytes for the offset:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:"NEXT_BYES :  BYTE_0 (SIZE)  -  BYTE_1 (SIZE)  -  BYTE_2 (OFFSET)  -  BYTE_3(OFFSET)\n               SHIFT(16)         NO_SHIFT           SHIFT(16)           SHIFT(8)\n"})}),"\n",(0,i.jsxs)(t.p,{children:["Once having this, we are good to start copy from the indicated ",(0,i.jsx)(t.code,{children:"offset"})," until the indicated ",(0,i.jsx)(t.code,{children:"size"}),"."]}),"\n",(0,i.jsx)(t.h4,{id:"add",children:"ADD"}),"\n",(0,i.jsxs)(t.p,{children:["The ",(0,i.jsx)(t.code,{children:"ADD"})," command is pretty straight forward, we just need to read the lower 7 bits (a maximum of 127 characters) which are the size of the content to copy, content that start on the next byte.\nLet\u2019s say you encounter this in the delta stream:"]}),"\n",(0,i.jsx)(t.h5,{id:"breakdown",children:"Breakdown:"}),"\n",(0,i.jsxs)(t.ol,{children:["\n",(0,i.jsxs)(t.li,{children:["\n",(0,i.jsx)(t.p,{children:(0,i.jsxs)(t.strong,{children:["Tag Byte ",(0,i.jsx)(t.code,{children:"7F"}),":"]})}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:["MSB = ",(0,i.jsx)(t.code,{children:"0"})," \u2192 Indicates an ",(0,i.jsx)(t.code,{children:"ADD"})," command."]}),"\n",(0,i.jsxs)(t.li,{children:["Lower 7 bits = ",(0,i.jsx)(t.code,{children:"0x7F"})," \u2192 Specifies that ",(0,i.jsx)(t.strong,{children:"127 literal bytes"})," follow this tag."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(t.li,{children:["\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.strong,{children:"Literal Bytes:"})}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"Immediately after the tag byte, 127 bytes of data are added."}),"\n",(0,i.jsxs)(t.li,{children:["For example:","\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:"48 65 6C 6C 6F 20 77 6F 72 6C 64 21\n"})}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:["Interpreted as ASCII: ",(0,i.jsx)(t.code,{children:"Hello world!"})]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(t.p,{children:["If you need to add more than ",(0,i.jsx)(t.strong,{children:"127 bytes"})," of literal data, Git uses ",(0,i.jsxs)(t.strong,{children:["multiple consecutive ",(0,i.jsx)(t.code,{children:"ADD"})," commands"]}),". For example:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:"7F <127 bytes of data> 7F <127 bytes of data> ...\n"})}),"\n",(0,i.jsx)(t.h4,{id:"key-points",children:"Key Points:"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:["Each ",(0,i.jsx)(t.code,{children:"ADD"})," command is limited to ",(0,i.jsx)(t.strong,{children:"127 bytes"})," because the tag byte only has 7 bits to encode the length."]}),"\n",(0,i.jsxs)(t.li,{children:["For larger additions, split the data into chunks, each preceded by its own ",(0,i.jsx)(t.code,{children:"ADD"})," tag."]}),"\n"]})]})}function a(e={}){const{wrapper:t}={...(0,r.R)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(l,{...e})}):l(e)}},8453:(e,t,n)=>{n.d(t,{R:()=>o,x:()=>c});var s=n(6540);const i={},r=s.createContext(i);function o(e){const t=s.useContext(r);return s.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function c(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),s.createElement(r.Provider,{value:t},e.children)}}}]);